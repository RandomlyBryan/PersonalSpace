<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.95)",
                        darkGlass: "rgba(30, 41, 59, 0.95)",
                        sidebar: "rgba(15, 23, 42, 0.4)"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #4f46e5, #0ea5e9);
            min-height: 100vh;
            transition: background 0.5s ease;
            overflow: hidden; 
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .dark .sidebar { background: rgba(15, 23, 42, 0.6); }
        .nav-item.active { background: rgba(255, 255, 255, 0.3); border-left: 4px solid #fff; }
        .dark .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #6366f1; }
        .column-body { min-height: 200px; transition: background-color 0.2s; }
        .column-body.drag-over { background-color: rgba(99, 102, 241, 0.1); border-radius: 0.5rem; }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }

        .task-card { cursor: grab; }
        .task-card:active { cursor: grabbing; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Calendar Styles */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            border-top: 1px solid #e2e8f0; 
            border-left: 1px solid #e2e8f0;
        }
        .dark .calendar-grid {
            border-color: #334155;
        }
        
        /* Fixed Calendar Day CSS */
        .calendar-day { 
            min-height: 80px; 
            max-height: 110px; 
            overflow-y: auto;  
            overflow-x: hidden;
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            justify-content: flex-start;
            padding: 4px;
            font-size: 0.85rem; 
            cursor: pointer; 
            position: relative;
            transition: background 0.2s;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: rgba(255,255,255,0.4);
        }
        .calendar-day::-webkit-scrollbar { width: 2px; }
        .calendar-day::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }

        .dark .calendar-day {
            border-color: #334155;
            background: rgba(30, 41, 59, 0.4);
        }
        .calendar-day:hover { background: rgba(99, 102, 241, 0.2); }
        .calendar-day.today { background: #e0e7ff; color: #4338ca; font-weight: bold; }
        .dark .calendar-day.today { background: #312e81; color: #a5b4fc; }

        .cal-event-item {
            font-size: 0.65rem;
            line-height: 1.2;
            padding: 4px 5px;
            border-radius: 3px;
            background: rgba(16, 185, 129, 0.15);
            color: #065f46;
            margin-top: 2px;
            width: 100%;
            white-space: normal; 
            word-break: break-word;
            text-align: left; 
            border-left: 2px solid #10b981;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .dark .cal-event-item {
            background: rgba(16, 185, 129, 0.3);
            color: #d1fae5;
            border-left: 2px solid #34d399;
        }
        .cal-time { font-weight: 800; opacity: 0.9; font-size: 0.6rem; display: block; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom:1px; margin-bottom:1px;}
        .calendar-day-number { margin-bottom: 2px; }

        /* Flag Urgency System */
        .flag-btn {
            cursor: pointer;
            transition: all 0.2s;
            color: #cbd5e1; 
        }
        .dark .flag-btn { color: #475569; }
        
        .flag-rating:hover .flag-btn { color: #ef4444; } 
        .flag-btn:hover ~ .flag-btn { color: #cbd5e1; } 
        .dark .flag-rating:hover .flag-btn { color: #ef4444; }
        .dark .flag-btn:hover ~ .flag-btn { color: #475569; }
        .flag-btn.active { color: #ef4444; }
        
        .avatar-container:hover .avatar-overlay { opacity: 1; }
        
        .view-btn { transition: all 0.2s; }
        .view-btn.active { background-color: rgba(255,255,255,0.2); font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }

        .timer-active { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { text-shadow: 0 0 0 rgba(16, 185, 129, 0); }
            50% { text-shadow: 0 0 4px rgba(16, 185, 129, 0.5); }
            100% { text-shadow: 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-3 py-1 text-[10px] rounded-b-lg shadow-lg z-50 font-bold opacity-90">
        <i class="fas fa-database mr-1"></i> Local Storage Mode (Auto-Saving)
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarFile(this)">
    <input type="file" id="restore-upload" class="hidden" accept=".json" onchange="handleRestore(this)">

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20 transition-all duration-300 transform -translate-x-full md:translate-x-0 absolute md:relative" id="main-sidebar">
        
        <div class="p-6 text-white">
            <h1 class="text-xl font-bold tracking-tight"><i class="fas fa-layer-group mr-2"></i>PersonalSpace</h1>
            <p class="text-xs text-white/60 uppercase tracking-wider mt-1">Project Hub <span class="text-amber-300 text-[9px] border border-amber-300 px-1 rounded ml-1">LOCAL</span></p>
        </div>

        <div class="px-4 mb-4">
                <label class="text-[10px] text-white/60 uppercase font-bold block mb-1">Log In As:</label>
                <div class="relative">
                    <select id="user-switcher" onchange="switchUser(this.value)" class="w-full bg-white/20 border border-white/10 rounded px-2 py-2 text-sm text-white outline-none focus:bg-white/30 cursor-pointer appearance-none font-medium">
                        <option value="" class="text-slate-800 font-bold">â˜… Main Workspace (Admin)</option>
                        </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-white">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
                <p class="text-[10px] text-white/50 mt-1 italic" id="view-mode-hint">Loading...</p>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10 active">
                    <i class="fas fa-home w-5"></i> Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10">
                    <i class="fas fa-tasks w-5"></i> Task Tracker
                </button>
            </nav>

            <div class="p-4 border-t border-white/10">
                <h3 class="text-xs font-bold text-white/60 uppercase mb-3 flex justify-between items-center">
                    Team Members 
                    <span id="member-count" class="bg-white/20 px-2 rounded-full text-[10px]">0</span>
                </h3>
                
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="Name..." 
                        class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white placeholder-white/50 focus:outline-none focus:bg-white/20">
                    <button onclick="addMember()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-2 rounded text-sm transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <p class="text-[9px] text-white/40 italic mb-2">Click avatar to upload photo</p>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    <li class="text-white/50 text-xs italic">Loading team...</li>
                </ul>
            </div>

            <div class="p-4 flex flex-col gap-3 border-t border-white/10">
                <div class="flex justify-end">
                    <button onclick="toggleTheme()" class="text-white/50 hover:text-white transition text-xs" title="Toggle Theme"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="backupData()" class="bg-indigo-500/20 hover:bg-indigo-500/40 text-indigo-200 text-[10px] py-1 rounded transition flex items-center justify-center gap-1">
                        <i class="fas fa-download"></i> Backup
                    </button>
                    <button onclick="triggerRestore()" class="bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-200 text-[10px] py-1 rounded transition flex items-center justify-center gap-1">
                        <i class="fas fa-upload"></i> Restore
                    </button>
                </div>

                <button onclick="clearAllData()" class="text-left text-[10px] text-red-300 hover:text-red-100 transition flex items-center gap-2 mt-1">
                    <i class="fas fa-trash-alt"></i> Reset All Data
                </button>
                
                <div class="text-white/30 text-[10px] text-center mt-2 pt-2 border-t border-white/5">
                    &copy; 2025 PersonalSpace by RandomlyBryan
                </div>
            </div>
        </aside>

        <main class="flex-1 relative h-full overflow-hidden flex flex-col bg-white/5 backdrop-blur-sm">
            
            <button onclick="document.getElementById('main-sidebar').classList.toggle('-translate-x-full')" class="md:hidden absolute top-4 left-4 z-50 text-white bg-indigo-600 p-2 rounded-lg shadow-lg">
                <i class="fas fa-bars"></i>
            </button>

            <div id="view-dashboard" class="flex-1 overflow-hidden p-4 md:p-6 fade-in h-full flex flex-col">
                
                <header class="mb-4 text-white shrink-0">
                    <div class="flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-bold tracking-tight" id="clock">00:00</h1>
                            <p class="text-sm opacity-90 mt-1" id="date">Loading date...</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-light text-blue-100" id="greeting">Connecting...</p>
                            <span id="dashboard-owner-badge" class="bg-emerald-500/80 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider hidden shadow-lg border border-white/20">Private Workspace</span>
                        </div>
                    </div>
                </header>

                <div class="flex flex-col gap-4 flex-1 min-h-0">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-1 min-h-0">
                        
                        <div class="flex flex-col gap-4 h-full">
                            
                            <div class="glass-panel rounded-2xl p-4 shrink-0">
                                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-indigo-600 dark:text-indigo-400">
                                    <i class="fas fa-bullseye"></i> Daily Focus
                                </h2>
                                <input type="text" id="focus-input" placeholder="Main goal..." 
                                    class="w-full bg-transparent border-b-2 border-slate-200 dark:border-slate-600 py-1 focus:outline-none focus:border-indigo-500 transition dark:text-white text-sm"
                                    onchange="saveFocus(this.value)">
                            </div>

                            <div class="glass-panel rounded-2xl p-4 flex-1 flex flex-col min-h-0">
                                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-amber-500">
                                    <i class="fas fa-sticky-note"></i> Notes
                                </h2>
                                <textarea id="notepad" 
                                    class="flex-1 w-full bg-yellow-50 dark:bg-slate-700/30 border-none rounded-lg p-3 resize-none focus:ring-2 focus:ring-amber-300 outline-none transition text-slate-700 dark:text-slate-200 text-sm"
                                    placeholder="Type notes here..."
                                    onchange="saveNotes(this.value)"></textarea>
                                <div class="text-[10px] text-right mt-1 text-slate-400" id="notes-status">Saved</div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 glass-panel rounded-2xl p-4 flex flex-col h-full min-h-0">
                            <h2 class="text-sm font-bold mb-3 flex items-center gap-2 text-emerald-600 dark:text-emerald-400 shrink-0">
                                <i class="fas fa-check-circle"></i> My Tasks
                            </h2>
                            
                            <div class="flex flex-col gap-2 mb-3 bg-slate-50 dark:bg-slate-700/30 p-2 rounded-xl border border-slate-100 dark:border-slate-700 shrink-0">
                                <input type="text" id="quick-task-input" placeholder="New task..." 
                                    class="w-full bg-white dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white">
                                
                                <div class="flex gap-2">
                                    <select id="quick-task-assignee" class="flex-1 bg-white dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-lg px-2 py-1.5 text-[10px] font-bold text-slate-600 dark:text-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none cursor-pointer">
                                        <option value="">Unassigned</option>
                                    </select>

                                    <select id="quick-task-status" class="w-24 bg-white dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-lg px-2 py-1.5 text-[10px] font-bold text-slate-600 dark:text-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none cursor-pointer">
                                        <option value="todo">To Do</option>
                                        <option value="inprogress">Doing</option>
                                        <option value="done">Done</option>
                                    </select>
                                    
                                    <button onclick="addQuickTask()" class="bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg px-3 transition transform active:scale-95 shadow-lg shadow-emerald-500/30 text-xs">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex justify-between px-2 text-[10px] font-bold text-slate-400 uppercase mb-1 shrink-0">
                                <span>Task</span>
                                <span>Schedule, Urgency & Status</span>
                            </div>

                            <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2 pr-1 min-h-0"></ul>
                        </div>
                    </div>

                    <div class="glass-panel rounded-2xl p-4 flex flex-col h-[45%] shrink-0 min-h-[250px]">
                        <div class="flex justify-between items-center mb-2 shrink-0">
                            <h2 class="text-sm font-bold flex items-center gap-2 text-blue-600 dark:text-blue-400">
                                <i class="fas fa-calendar-alt"></i> Schedule
                            </h2>
                            <div class="flex gap-2 text-xs text-slate-600 dark:text-slate-300">
                                <button onclick="changeMonth(-1)" class="hover:text-blue-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-chevron-left"></i></button>
                                <span id="calendar-month-year" class="font-bold w-24 text-center flex items-center justify-center">...</span>
                                <button onclick="changeMonth(1)" class="hover:text-blue-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>

                        <div class="grid grid-cols-7 text-center text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-0 border-b border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 py-1 rounded-t-lg shrink-0">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>

                        <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto">
                        </div>
                        
                        <div class="mt-1 text-center text-[10px] text-slate-400 italic shrink-0">Click date to add event</div>
                    </div>

                </div>
            </div>

            <div id="view-kanban" class="flex-1 overflow-hidden p-4 md:p-6 fade-in hidden flex-col h-full">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 shrink-0 text-white gap-4">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            Task Tracker 
                            <span id="tracker-badge" class="text-xs bg-white/20 px-2 py-0.5 rounded text-white/80 font-normal">Main View</span>
                        </h2>
                        <p class="text-sm opacity-80" id="tracker-subtitle">Showing all project tasks</p>
                    </div>

                    <div class="bg-black/20 p-1 rounded-lg flex text-xs font-bold items-center gap-2">
                        <button onclick="switchKanbanView('status')" id="btn-view-status" class="view-btn active px-3 py-1.5 rounded text-white">Status</button>
                        <button onclick="switchKanbanView('week')" id="btn-view-week" class="view-btn px-3 py-1.5 rounded text-white text-opacity-70 hover:text-opacity-100">Week View</button>
                    </div>

                    <div id="kanban-filter-container" class="flex items-center gap-2 bg-black/20 p-1 rounded-lg">
                         <input type="date" id="filter-start-date" class="bg-white/10 border-none text-white text-xs rounded px-2 py-1 outline-none w-28" onchange="renderKanbanBoard()">
                         <span class="text-white/50 text-xs">-</span>
                         <input type="date" id="filter-end-date" class="bg-white/10 border-none text-white text-xs rounded px-2 py-1 outline-none w-28" onchange="renderKanbanBoard()">
                         <button onclick="clearFilters()" class="text-xs text-white/50 hover:text-white px-2"><i class="fas fa-times"></i></button>
                    </div>

                    <div id="week-nav-container" class="hidden flex items-center gap-2 bg-black/20 p-1 rounded-lg">
                        <button onclick="changeWeek(-1)" class="text-white hover:text-indigo-300 px-2"><i class="fas fa-chevron-left"></i></button>
                        <span id="week-view-label" class="text-xs text-white font-bold w-24 text-center">...</span>
                        <button onclick="changeWeek(1)" class="text-white hover:text-indigo-300 px-2"><i class="fas fa-chevron-right"></i></button>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="toggleReportModal()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg backdrop-blur transition flex items-center gap-2 text-sm">
                            <i class="fas fa-chart-pie"></i> Report
                        </button>
                        <button onclick="openTaskModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg transition flex items-center gap-2 text-sm">
                            <i class="fas fa-plus"></i> New Task
                        </button>
                    </div>
                </div>

                <div id="kanban-status-view" class="flex-1 overflow-x-auto overflow-y-hidden pb-2 h-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-w-[800px] md:min-w-0">
                        
                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-slate-400">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-700 dark:text-slate-200">To Do</h3>
                                <span id="count-todo" class="bg-slate-200 dark:bg-slate-700 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'todo', 'status')" ondragover="allowDrop(event)"></div>
                        </div>

                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-indigo-500">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-indigo-600 dark:text-indigo-400">In Progress</h3>
                                <span id="count-inprogress" class="bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'inprogress', 'status')" ondragover="allowDrop(event)"></div>
                        </div>

                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-emerald-500">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-emerald-600 dark:text-emerald-400">Completed</h3>
                                <span id="count-done" class="bg-emerald-100 dark:bg-emerald-900/50 text-emerald-600 dark:text-emerald-300 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'done', 'status')" ondragover="allowDrop(event)"></div>
                        </div>

                    </div>
                </div>

                <div id="kanban-week-view" class="flex-1 overflow-x-auto overflow-y-hidden pb-2 h-full hidden">
                    <div class="grid grid-cols-7 gap-2 h-full min-w-[1400px]">
                        <div id="week-columns-container" class="contents"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 dark:text-white" id="modal-title">Task Details</h2>
            <input type="hidden" id="task-id">
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                <input type="text" id="task-title" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white">
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Assign To</label>
                    <select id="task-assignee" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white">
                        <option value="">Unassigned</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Scheduled Date</label>
                    <input type="date" id="task-date" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white text-sm">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Urgency Level</label>
                <div class="flex gap-3 text-xl flag-rating" id="priority-selector">
                    <input type="hidden" id="task-priority" value="1">
                    <i class="fas fa-flag flag-btn" data-val="1" onclick="setPriority(1)"></i>
                    <i class="fas fa-flag flag-btn" data-val="2" onclick="setPriority(2)"></i>
                    <i class="fas fa-flag flag-btn" data-val="3" onclick="setPriority(3)"></i>
                    <i class="fas fa-flag flag-btn" data-val="4" onclick="setPriority(4)"></i>
                    <i class="fas fa-flag flag-btn" data-val="5" onclick="setPriority(5)"></i>
                </div>
                <p class="text-[10px] text-slate-400 mt-1" id="priority-text">Low Urgency</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                <textarea id="task-desc" rows="3" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white"></textarea>
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="deleteCurrentTask()" id="btn-delete" class="text-red-500 hover:text-red-700 text-sm hidden">Delete Task</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="closeModal('task-modal')" class="px-4 py-2 text-slate-500 dark:text-slate-400">Cancel</button>
                    <button onclick="saveTask()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h2 class="text-lg font-bold mb-1 dark:text-white" id="cal-date-title">Date</h2>
            <p class="text-xs text-slate-500 mb-4">Scheduled Events</p>
            <input type="hidden" id="cal-date-val">
            
            <div id="day-events-list" class="mb-4 space-y-2 max-h-40 overflow-y-auto min-h-[50px] bg-slate-50 dark:bg-slate-700/50 rounded-lg p-2"></div>

            <div class="flex flex-col gap-2">
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Start</label>
                        <input type="time" id="new-event-start" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">End</label>
                        <input type="time" id="new-event-end" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white">
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="new-event-input" placeholder="Event details..." class="flex-1 bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white">
                    
                    <button onclick="addEvent()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            
            <div class="mt-4 text-right">
                <button onclick="closeModal('calendar-modal')" class="text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Close</button>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white"><i class="fas fa-clipboard-list mr-2 text-indigo-500"></i>Performance Report</h2>
                <button onclick="toggleReportModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex gap-4 mb-6 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl items-end flex-wrap">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">From</label>
                    <input type="date" id="report-start" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">To</label>
                    <input type="date" id="report-end" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">User</label>
                    <select id="report-user-filter" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white outline-none w-32">
                        <option value="">All Users</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Generic Day</label>
                    <select id="report-day-filter" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white outline-none w-32">
                        <option value="">Any</option>
                        <option value="Sunday">Sunday</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                    </select>
                </div>

                <button onclick="generateReport()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 h-[38px]">Apply</button>
                
                <button onclick="exportReportCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 h-[38px] ml-auto">
                    <i class="fas fa-file-csv mr-1"></i> Export CSV
                </button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 sticky top-0">
                        <tr>
                            <th class="p-3">Task</th>
                            <th class="p-3">Assignee</th>
                            <th class="p-3">Completed</th>
                            <th class="p-3 text-right">Work Time</th>
                        </tr>
                    </thead>
                    <tbody id="report-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const store = {
            theme: localStorage.getItem('nexus_theme') || 'light',
            currentUser: null,
            users: [],
            kanbanTasks: [],
            avatars: {}, 
            focus: '',
            notes: '',
            events: {}, 
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            kanbanMode: 'status',
            // New: Week View State
            weekViewStart: new Date() // Will settle to current week's Sunday
        };
        
        let draggedItem = null;
        let uploadingUser = null;

        // --- EXPOSE FUNCTIONS ---
        window.switchUser = switchUser;
        window.switchView = switchView;
        window.switchKanbanView = switchKanbanView;
        window.addMember = addMember;
        window.removeMember = removeMember;
        window.toggleTheme = toggleTheme;
        window.saveFocus = saveFocus;
        window.saveNotes = saveNotes;
        window.addQuickTask = addQuickTask;
        window.deleteQuickTask = deleteQuickTask;
        window.updateTaskStatus = updateTaskStatus;
        window.updateTaskPriority = updateTaskPriority;
        window.updateTaskDate = updateTaskDate; // Updated from updateTaskDay
        window.toggleTaskPause = toggleTaskPause;
        window.openTaskModal = openTaskModal;
        window.closeModal = closeModal;
        window.saveTask = saveTask;
        window.deleteCurrentTask = deleteCurrentTask;
        window.toggleReportModal = toggleReportModal;
        window.generateReport = generateReport;
        window.clearAllData = clearAllData;
        window.backupData = backupData;
        window.triggerRestore = triggerRestore;
        window.handleRestore = handleRestore;
        window.exportReportCSV = exportReportCSV;
        window.setPriority = setPriority;
        window.clearFilters = clearFilters;
        window.changeWeek = changeWeek;
        
        window.triggerAvatarUpload = triggerAvatarUpload;
        window.handleAvatarFile = handleAvatarFile;

        window.changeMonth = changeMonth;
        window.openCalendarModal = openCalendarModal;
        window.addEvent = addEvent;
        window.deleteEvent = deleteEvent;

        // Drag & Drop
        window.dragStart = (e, id) => { draggedItem = id; e.target.classList.add('dragging'); };
        window.dragEnd = (e) => { e.target.classList.remove('dragging'); document.querySelectorAll('.column-body').forEach(c => c.classList.remove('drag-over')); };
        window.allowDrop = (e) => { e.preventDefault(); e.target.closest('.column-body')?.classList.add('drag-over'); };
        
        window.drop = (e, val, type) => {
            e.preventDefault();
            const col = e.target.closest('.column-body');
            col?.classList.remove('drag-over');
            if(draggedItem) { 
                if(type === 'status') updateTaskStatus(draggedItem, val); 
                // Val here will be the specific YYYY-MM-DD date string for the column
                if(type === 'date') updateTaskDate(draggedItem, val);
                draggedItem = null; 
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            updateClock();
            setInterval(updateClock, 1000);
            
            // Set current week start (Sunday)
            const today = new Date();
            const day = today.getDay(); 
            const diff = today.getDate() - day; 
            store.weekViewStart = new Date(today.setDate(diff));
            store.weekViewStart.setHours(0,0,0,0);

            // Report defaults
            const now = new Date();
            document.getElementById('report-end').valueAsDate = now;
            document.getElementById('report-start').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
            
            document.getElementById('quick-task-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addQuickTask();
            });

            // Initialize Local Data
            store.users = JSON.parse(localStorage.getItem('nexus_users')) || [];
            store.kanbanTasks = JSON.parse(localStorage.getItem('nexus_kanban')) || [];
            store.events = JSON.parse(localStorage.getItem('nexus_events')) || {};
            store.avatars = JSON.parse(localStorage.getItem('nexus_avatars')) || {};

            renderTeamList();
            renderKanbanBoard(); // This will trigger generateWeekColumns inside
            renderCalendar();
            
            setInterval(updateKanbanTimers, 1000);
        });

        // --- CORE LOGIC (LOCAL STORAGE) ---

        function switchUser(userName) {
            store.currentUser = userName || null;
            document.getElementById('user-switcher').value = userName;
            
            const key = `nexus_${store.currentUser || 'admin'}`;
            store.focus = localStorage.getItem(`${key}_focus`) || '';
            store.notes = localStorage.getItem(`${key}_notes`) || '';
            
            updateUIForUser();
            updateDashboardUI();
            renderKanbanBoard(); 
        }

        function updateUIForUser() {
            const badge = document.getElementById('dashboard-owner-badge');
            const greeting = document.getElementById('greeting');
            const hint = document.getElementById('view-mode-hint');
            const trackerBadge = document.getElementById('tracker-badge');
            const trackerSub = document.getElementById('tracker-subtitle');

            if (store.currentUser) {
                badge.textContent = `${store.currentUser}'s Workspace`;
                badge.classList.remove('hidden');
                greeting.textContent = `Hello, ${store.currentUser}.`;
                hint.textContent = "Private View (Local)";
                trackerBadge.textContent = "Personal Filter";
                trackerSub.textContent = `Tasks assigned to ${store.currentUser}`;
            } else {
                badge.classList.add('hidden');
                updateClock();
                hint.textContent = "Admin View (Local)";
                trackerBadge.textContent = "Main View";
                trackerSub.textContent = "Showing all project tasks";
            }
        }

        function updateDashboardUI() {
            document.getElementById('focus-input').value = store.focus;
            document.getElementById('notepad').value = store.notes;
            renderQuickTasks(); 
        }

        // --- AVATAR UPLOAD LOGIC ---
        function triggerAvatarUpload(username) {
            uploadingUser = username;
            document.getElementById('avatar-upload').click();
        }

        function handleAvatarFile(input) {
            if (input.files && input.files[0] && uploadingUser) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Img = e.target.result;
                    if(base64Img.length > 700000) {
                        alert("Image too large. Please use a smaller image (<500KB).");
                        return;
                    }
                    store.avatars[uploadingUser] = base64Img;
                    localStorage.setItem('nexus_avatars', JSON.stringify(store.avatars));
                    renderTeamList();
                    renderQuickTasks();
                    renderKanbanBoard();
                }
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        // --- SAVING ---
        function saveFocus(val) {
            store.focus = val;
            const key = `nexus_${store.currentUser || 'admin'}`;
            localStorage.setItem(`${key}_focus`, val);
        }
        function saveNotes(val) {
            store.notes = val;
            const key = `nexus_${store.currentUser || 'admin'}`;
            localStorage.setItem(`${key}_notes`, val);
            document.getElementById('notes-status').textContent = 'Saved';
        }

        // --- CALENDAR LOGIC ---
        function changeMonth(delta) {
            store.calendarMonth += delta;
            if(store.calendarMonth > 11) { store.calendarMonth = 0; store.calendarYear++; }
            if(store.calendarMonth < 0) { store.calendarMonth = 11; store.calendarYear--; }
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendar-month-year').textContent = `${monthNames[store.calendarMonth]} ${store.calendarYear}`;
            
            const firstDay = new Date(store.calendarYear, store.calendarMonth, 1).getDay();
            const daysInMonth = new Date(store.calendarYear, store.calendarMonth + 1, 0).getDate();
            const today = new Date();
            
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';

            for(let i=0; i<firstDay; i++) {
                const pad = document.createElement('div');
                pad.className = "bg-slate-50/50 dark:bg-slate-800/50 border-r border-b border-slate-200 dark:border-slate-700";
                grid.appendChild(pad);
            }

            for(let d=1; d<=daysInMonth; d++) {
                const dateKey = `${store.calendarYear}-${String(store.calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = (today.getDate() === d && today.getMonth() === store.calendarMonth && today.getFullYear() === store.calendarYear);
                const events = store.events[dateKey] || [];
                
                const el = document.createElement('div');
                el.className = `calendar-day ${isToday ? 'today' : ''}`;
                
                const num = document.createElement('div');
                num.className = "calendar-day-number";
                num.textContent = d;
                el.appendChild(num);
                
                events.forEach(evtStr => {
                    const evtDiv = document.createElement('div');
                    evtDiv.className = "cal-event-item";
                    if (evtStr.includes("||")) {
                        const parts = evtStr.split("||");
                        evtDiv.innerHTML = `<span class="cal-time">${parts[0]}</span><span>${parts[1]}</span>`;
                    } else {
                        evtDiv.textContent = evtStr;
                    }
                    el.appendChild(evtDiv);
                });

                el.onclick = () => openCalendarModal(dateKey);
                grid.appendChild(el);
            }
        }

        function openCalendarModal(dateStr) {
            document.getElementById('calendar-modal').classList.remove('hidden');
            document.getElementById('cal-date-title').textContent = new Date(dateStr).toDateString();
            document.getElementById('cal-date-val').value = dateStr;
            document.getElementById('new-event-start').value = ''; 
            document.getElementById('new-event-end').value = ''; 
            renderDayEvents(dateStr);
        }

        function renderDayEvents(dateStr) {
            const list = document.getElementById('day-events-list');
            list.innerHTML = '';
            const events = store.events[dateStr] || [];
            
            if(events.length === 0) {
                list.innerHTML = '<div class="text-xs text-slate-400 italic text-center p-2">No events scheduled.</div>';
                return;
            }

            events.forEach((evtStr, idx) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white dark:bg-slate-600 p-2 rounded text-xs dark:text-white border border-slate-200 dark:border-slate-500";
                
                let displayHtml = evtStr;
                if(evtStr.includes("||")) {
                    const parts = evtStr.split("||");
                    displayHtml = `<span class="font-bold mr-2">${parts[0]}</span> ${parts[1]}`;
                }

                div.innerHTML = `<div>${displayHtml}</div> <button onclick="deleteEvent('${dateStr}', ${idx})" class="text-red-400 hover:text-red-500"><i class="fas fa-times"></i></button>`;
                list.appendChild(div);
            });
        }

        function addEvent() {
            const val = document.getElementById('new-event-input').value.trim();
            const startVal = document.getElementById('new-event-start').value;
            const endVal = document.getElementById('new-event-end').value;
            const dateStr = document.getElementById('cal-date-val').value;
            
            if(val) {
                if(!store.events[dateStr]) store.events[dateStr] = [];
                let entry = val;
                if(startVal) {
                    let timeStr = startVal;
                    if(endVal) timeStr += ` - ${endVal}`;
                    entry = `${timeStr}||${val}`;
                }
                store.events[dateStr].push(entry);
                store.events[dateStr].sort();
                localStorage.setItem('nexus_events', JSON.stringify(store.events));
                document.getElementById('new-event-input').value = '';
                document.getElementById('new-event-start').value = '';
                document.getElementById('new-event-end').value = '';
                renderDayEvents(dateStr);
                renderCalendar(); 
            }
        }

        function deleteEvent(dateStr, idx) {
            store.events[dateStr].splice(idx, 1);
            if(store.events[dateStr].length === 0) delete store.events[dateStr];
            localStorage.setItem('nexus_events', JSON.stringify(store.events));
            renderDayEvents(dateStr);
            renderCalendar();
        }

        // --- TASKS LOGIC ---
        function addQuickTask() {
            const val = document.getElementById('quick-task-input').value.trim();
            const status = document.getElementById('quick-task-status').value;
            const assignee = document.getElementById('quick-task-assignee').value || store.currentUser || "Unassigned";
            
            if(val) {
                const now = Date.now();
                const newTask = { 
                    id: Date.now().toString(),
                    title: val, description: "", assignee: assignee,
                    status: status, createdAt: now, 
                    priority: 1, 
                    assignedDate: "", // Changed from assignedDay to assignedDate (YYYY-MM-DD)
                    isPaused: false, 
                    completedAt: (status === 'done' ? now : null), 
                    lastMoved: now, log: { todo: 0, inprogress: 0, done: 0 } 
                };

                store.kanbanTasks.push(newTask);
                localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
                renderKanbanBoard();
                
                document.getElementById('quick-task-input').value = '';
            }
        }

        function deleteQuickTask(id) {
            if(confirm('Delete this task?')) {
                store.kanbanTasks = store.kanbanTasks.filter(t => t.id !== id);
                localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
                renderKanbanBoard();
            }
        }

        function addMember() {
            const name = document.getElementById('new-member-name').value.trim();
            if(name && !store.users.includes(name)) {
                store.users.push(name);
                document.getElementById('new-member-name').value = '';
                localStorage.setItem('nexus_users', JSON.stringify(store.users));
                renderTeamList();
            }
        }
        function removeMember(idx) {
            if(confirm('Remove user?')) {
                store.users.splice(idx, 1);
                localStorage.setItem('nexus_users', JSON.stringify(store.users));
                renderTeamList();
            }
        }

        function setPriority(val) {
            document.getElementById('task-priority').value = val;
            const flags = document.querySelectorAll('.flag-btn');
            const texts = ["Low Urgency", "Low Urgency", "Medium Urgency", "High Urgency", "Critical Urgency"];
            flags.forEach(f => {
                if (parseInt(f.dataset.val) <= val) {
                    f.classList.add('active'); f.classList.remove('text-slate-300');
                } else {
                    f.classList.remove('active'); f.classList.add('text-slate-300');
                }
            });
            document.getElementById('priority-text').textContent = texts[val-1];
        }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value;
            const desc = document.getElementById('task-desc').value;
            const priority = parseInt(document.getElementById('task-priority').value) || 1;
            const assignedDate = document.getElementById('task-date').value; 
            
            let assignee = document.getElementById('task-assignee').value;
            if (store.currentUser && assignee === "") assignee = store.currentUser;
            if(!title) return alert('Title required');

            const taskData = { title, description: desc, assignee, priority, assignedDate };

            if(id) {
                const t = store.kanbanTasks.find(x => x.id == id);
                if(t) Object.assign(t, taskData);
            } else {
                store.kanbanTasks.push({ id: Date.now().toString(), ...taskData, status: 'todo', createdAt: Date.now(), completedAt: null, lastMoved: Date.now(), log: { todo: 0, inprogress: 0, done: 0 }, isPaused: false });
            }
            localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
            renderKanbanBoard();
            closeModal('task-modal');
        }

        function updateTaskStatus(id, newStatus) {
            const task = store.kanbanTasks.find(t => t.id === id);
            if (!task || task.status === newStatus) return;

            const now = Date.now();
            let newLog = task.log ? { ...task.log } : { todo: 0, inprogress: 0, done: 0 };
            
            if (task.status === 'inprogress' && !task.isPaused) {
                const elapsed = Math.floor((now - task.lastMoved) / 1000);
                newLog['inprogress'] = (newLog['inprogress'] || 0) + elapsed;
            }

            task.status = newStatus;
            task.lastMoved = now;
            task.log = newLog;
            task.completedAt = (newStatus === 'done') ? now : null;
            task.isPaused = false; 
            
            localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
            renderKanbanBoard();
        }

        function toggleTaskPause(id) {
            const task = store.kanbanTasks.find(t => t.id === id);
            if (!task || task.status !== 'inprogress') return;

            const now = Date.now();
            if (task.isPaused) {
                task.isPaused = false;
                task.lastMoved = now; 
            } else {
                const elapsed = Math.floor((now - task.lastMoved) / 1000);
                task.log['inprogress'] = (task.log['inprogress'] || 0) + elapsed;
                task.isPaused = true;
            }
            localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
            renderKanbanBoard();
        }

        // Updated to use Date
        function updateTaskDate(id, newDate) {
            const task = store.kanbanTasks.find(t => t.id === id);
            if (!task || task.assignedDate === newDate) return;
            task.assignedDate = newDate;
            localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
            renderKanbanBoard();
        }

        function updateTaskPriority(id, newPriority) {
            const task = store.kanbanTasks.find(t => t.id === id);
            if (!task) return;
            task.priority = parseInt(newPriority);
            localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
            renderKanbanBoard();
        }

        function deleteCurrentTask() {
            const id = document.getElementById('task-id').value;
            if(id && confirm('Delete?')) {
                store.kanbanTasks = store.kanbanTasks.filter(t => t.id != id);
                localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
                renderKanbanBoard();
                closeModal('task-modal');
            }
        }

        // --- FILTERING ---
        function clearFilters() {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            renderKanbanBoard();
        }

        // --- WEEKLY VIEW LOGIC ---
        function switchKanbanView(mode) {
            store.kanbanMode = mode;
            const statusView = document.getElementById('kanban-status-view');
            const weekView = document.getElementById('kanban-week-view');
            const btnStatus = document.getElementById('btn-view-status');
            const btnWeek = document.getElementById('btn-view-week');
            const filterContainer = document.getElementById('kanban-filter-container');
            const weekNavContainer = document.getElementById('week-nav-container');

            if (mode === 'status') {
                statusView.classList.remove('hidden');
                weekView.classList.add('hidden');
                btnStatus.classList.add('active', 'text-white'); btnStatus.classList.remove('text-opacity-70');
                btnWeek.classList.remove('active'); btnWeek.classList.add('text-opacity-70');
                filterContainer.classList.remove('hidden');
                weekNavContainer.classList.add('hidden');
            } else {
                statusView.classList.add('hidden');
                weekView.classList.remove('hidden');
                btnWeek.classList.add('active', 'text-white'); btnWeek.classList.remove('text-opacity-70');
                btnStatus.classList.remove('active'); btnStatus.classList.add('text-opacity-70');
                filterContainer.classList.add('hidden');
                weekNavContainer.classList.remove('hidden');
            }
            renderKanbanBoard();
        }

        function changeWeek(delta) {
            // Move store.weekViewStart by 7 days
            store.weekViewStart.setDate(store.weekViewStart.getDate() + (delta * 7));
            generateWeekColumns();
            renderKanbanBoard();
        }

        function generateWeekColumns() {
            const container = document.getElementById('week-columns-container');
            container.innerHTML = '';
            
            const curr = new Date(store.weekViewStart); // Start at sunday
            const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            // Update label
            const endOfWeek = new Date(curr);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            document.getElementById('week-view-label').textContent = `${curr.getMonth()+1}/${curr.getDate()} - ${endOfWeek.getMonth()+1}/${endOfWeek.getDate()}`;

            for (let i = 0; i < 7; i++) {
                const dateStr = curr.toISOString().split('T')[0]; // YYYY-MM-DD
                const displayDate = `${days[curr.getDay()]} ${curr.getMonth()+1}/${curr.getDate()}`;
                
                const col = document.createElement('div');
                col.className = "glass-panel rounded-xl flex flex-col h-full border-t-2 border-slate-300 dark:border-slate-600 min-w-[200px]";
                col.innerHTML = `
                    <div class="p-2 border-b border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 text-center">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm">${displayDate}</h3>
                    </div>
                    <div class="column-body p-2 flex-1 overflow-y-auto space-y-2" ondrop="drop(event, '${dateStr}', 'date')" ondragover="allowDrop(event)" id="col-${dateStr}">
                        </div>
                `;
                container.appendChild(col);
                
                curr.setDate(curr.getDate() + 1); // Next day
            }
        }
        
        // --- DATA MANAGEMENT ---
        function clearAllData() {
            if(confirm("WARNING: This will delete ALL tasks, users, and settings. This cannot be undone.\n\nAre you sure?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function backupData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('nexus_')) {
                    data[key] = localStorage.getItem(key);
                }
            }
            if (Object.keys(data).length === 0) {
                alert("No data to backup.");
                return;
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `personalspace_backup_${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerRestore() {
            document.getElementById('restore-upload').click();
        }

        function handleRestore(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!confirm("This will overwrite your current data with the backup. Continue?")) return;
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('nexus_')) keysToRemove.push(key);
                        }
                        keysToRemove.forEach(k => localStorage.removeItem(k));
                        Object.keys(data).forEach(key => {
                            if (key.startsWith('nexus_')) {
                                localStorage.setItem(key, data[key]);
                            }
                        });
                        alert("Data restored successfully!");
                        location.reload();
                    } catch (err) {
                        alert("Error parsing backup file. Please ensure it is a valid JSON backup.");
                    }
                }
                reader.readAsText(input.files[0]);
            }
            input.value = '';
        }

        // --- RENDER UTILS ---
        function renderTeamList() {
            const list = document.getElementById('team-list');
            document.getElementById('member-count').textContent = store.users.length;
            list.innerHTML = '';
            
            const taskDropdown = document.getElementById('task-assignee');
            taskDropdown.innerHTML = '<option value="">Unassigned</option>';

            const quickTaskAssignee = document.getElementById('quick-task-assignee');
            if(quickTaskAssignee) {
                quickTaskAssignee.innerHTML = '<option value="">Assign to...</option>';
            }

            const reportUserFilter = document.getElementById('report-user-filter');
            const currentReportFilter = reportUserFilter ? reportUserFilter.value : "";
            if(reportUserFilter) {
                reportUserFilter.innerHTML = '<option value="">All Users</option>';
            }

            const userSwitcher = document.getElementById('user-switcher');
            userSwitcher.innerHTML = '<option value="" class="text-slate-800 font-bold">â˜… Main Workspace (Admin)</option>';

            store.users.forEach((user, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm text-white/80 bg-white/5 px-2 py-1 rounded hover:bg-white/10 transition group';
                
                let avatarHTML = `<div class="w-5 h-5 rounded-full bg-indigo-500 flex items-center justify-center text-[10px] text-white font-bold">${user.charAt(0).toUpperCase()}</div>`;
                if(store.avatars[user]) {
                    avatarHTML = `<div class="w-5 h-5 rounded-full bg-cover bg-center border border-white/20" style="background-image: url('${store.avatars[user]}')"></div>`;
                }

                li.innerHTML = `
                    <div class="flex items-center gap-2 cursor-pointer avatar-container relative" onclick="triggerAvatarUpload('${user}')">
                        ${avatarHTML}
                        <div class="avatar-overlay absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 transition">
                            <i class="fas fa-camera text-[8px] text-white"></i>
                        </div>
                        <span>${user}</span>
                    </div>
                    <button onclick="removeMember(${index})" class="opacity-0 group-hover:opacity-100 hover:text-red-400"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(li);

                const opt = document.createElement('option');
                opt.value = user; opt.textContent = user;
                taskDropdown.appendChild(opt);

                if(quickTaskAssignee) {
                    const opt2 = document.createElement('option');
                    opt2.value = user; opt2.textContent = user;
                    quickTaskAssignee.appendChild(opt2);
                }

                if(reportUserFilter) {
                    const opt3 = document.createElement('option');
                    opt3.value = user; opt3.textContent = user;
                    if(user === currentReportFilter) opt3.selected = true;
                    reportUserFilter.appendChild(opt3);
                }

                const switchOpt = document.createElement('option');
                switchOpt.value = user; switchOpt.textContent = user; switchOpt.className = "text-slate-800";
                if(store.currentUser === user) switchOpt.selected = true;
                userSwitcher.appendChild(switchOpt);
            });
        }

        function createCardHTML(t) {
             let timerHtml = '';
             let statusColor = 'border-l-4 border-slate-300';
             
             if (t.status === 'inprogress') {
                 const logVal = t.log ? t.log['inprogress'] || 0 : 0;
                 let displayTime = logVal;
                 let playPauseIcon = '<i class="fas fa-pause"></i>';
                 let activeClass = 'timer-active';
                 let colorClass = 'text-indigo-600';

                 if (t.isPaused) {
                     playPauseIcon = '<i class="fas fa-play"></i>';
                     activeClass = '';
                     colorClass = 'text-amber-500';
                 } else {
                     displayTime += Math.floor((Date.now() - t.lastMoved) / 1000);
                 }

                 timerHtml = `
                    <div class="flex items-center gap-2">
                         <button onclick="toggleTaskPause('${t.id}')" class="w-5 h-5 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center text-[10px] ${colorClass} transition">
                            ${playPauseIcon}
                         </button>
                         <div class="text-xs ${colorClass} font-bold flex items-center gap-1 ${activeClass}" id="timer-${t.id}" data-last="${t.lastMoved}" data-stored="${logVal}" data-paused="${t.isPaused}">
                            <i class="fas fa-stopwatch"></i> <span>${formatTime(displayTime)}</span>
                         </div>
                    </div>
                 `;
                 statusColor = t.isPaused ? 'border-l-4 border-amber-400 pl-2' : 'border-l-4 border-indigo-500 pl-2';

             } else if (t.status === 'done') {
                 const totalWorkTime = t.log ? t.log['inprogress'] || 0 : 0;
                 timerHtml = `<div class="text-xs text-emerald-600 font-medium flex items-center gap-1"><i class="fas fa-check-circle"></i> <span>${formatTime(totalWorkTime)}</span></div>`;
                 statusColor = 'border-l-4 border-emerald-500 pl-2 opacity-70';
             } else {
                 statusColor = 'border-l-4 border-slate-300 pl-2';
                 timerHtml = `<div class="text-xs text-slate-400 italic">To Do</div>`;
             }

             // Assignee
             let assigneeHtml = '';
             if (t.assignee) {
                 const hasImg = store.avatars[t.assignee];
                 const icon = hasImg 
                     ? `<div class="w-4 h-4 rounded-full bg-cover bg-center border border-indigo-200" style="background-image: url('${hasImg}')"></div>` 
                     : `<i class="fas fa-user"></i>`;
                 assigneeHtml = `<div class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1">${icon} ${t.assignee}</div>`;
             }

             // Flags
             const priority = t.priority || 1; 
             let flagsHtml = '';
             let flagColor = 'text-slate-300';
             if (priority >= 3) flagColor = 'text-amber-400';
             if (priority >= 4) flagColor = 'text-red-500';
             if (priority <= 2 && priority > 0) flagColor = 'text-emerald-400';
             for(let i=0; i<priority; i++) flagsHtml += `<i class="fas fa-flag text-[10px] ${flagColor} ml-0.5"></i>`;

             // Date Label in Card
             let dateLabel = "";
             if (t.assignedDate) {
                 const d = new Date(t.assignedDate);
                 dateLabel = `<span class="text-[9px] bg-slate-100 dark:bg-slate-700 text-slate-500 px-1 rounded border border-slate-200 dark:border-slate-600">${d.getMonth()+1}/${d.getDate()}</span>`;
             }

             return `
                 <div class="${statusColor}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 min-w-0 mr-2">
                            <h4 class="font-bold text-slate-800 dark:text-slate-100 text-sm leading-tight truncate">${t.title}</h4>
                            <div class="flex gap-1 mt-1">${dateLabel}</div>
                        </div>
                        <button onclick="openTaskModal('${t.id}')" class="text-slate-300 hover:text-indigo-500 opacity-0 group-hover:opacity-100"><i class="fas fa-pen text-xs"></i></button>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 line-clamp-2">${t.description || ''}</p>
                    <div class="flex justify-between items-end border-t border-slate-100 dark:border-slate-700 pt-2">
                        <div class="flex flex-col gap-1">${assigneeHtml}</div>
                        <div class="flex flex-col items-end gap-1"><div>${flagsHtml}</div>${timerHtml}</div>
                    </div>
                 </div>
             `;
        }

        function renderKanbanBoard() {
            // Get Filters
            const filterStart = document.getElementById('filter-start-date').value;
            const filterEnd = document.getElementById('filter-end-date').value;

            // Status View Rendering
            if (store.kanbanMode === 'status') {
                ['todo', 'inprogress', 'done'].forEach(status => {
                    const container = document.querySelector(`[ondrop="drop(event, '${status}', 'status')"]`);
                    const tasks = store.kanbanTasks.filter(t => {
                        if (t.status !== status) return false;
                        if (store.currentUser && t.assignee !== store.currentUser) return false;
                        
                        // Date Range Filter Logic
                        if (filterStart || filterEnd) {
                            if (!t.assignedDate) return false; // Strict filtering: no date = hidden if filter is active
                            const taskDate = t.assignedDate;
                            if (filterStart && taskDate < filterStart) return false;
                            if (filterEnd && taskDate > filterEnd) return false;
                        }

                        return true; 
                    });

                    container.innerHTML = '';
                    document.getElementById(`count-${status}`).textContent = tasks.length;

                    if (tasks.length === 0) {
                        const msg = (filterStart || filterEnd) ? "No tasks in range." : (store.currentUser ? "No tasks assigned to you." : "No tasks.");
                        container.innerHTML = `<div class="text-center text-slate-400 text-xs italic p-4 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg">${msg}</div>`;
                        return;
                    }

                    tasks.forEach(t => {
                        const el = document.createElement('div');
                        el.className = 'task-card bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition group relative';
                        el.draggable = true;
                        el.ondragstart = (e) => window.dragStart(e, t.id);
                        el.ondragend = window.dragEnd;
                        el.innerHTML = createCardHTML(t);
                        container.appendChild(el);
                    });
                });
            } else {
                // Week View Rendering
                if (document.getElementById('week-columns-container').children.length === 0) {
                    generateWeekColumns();
                }

                // We need to re-render tasks into specific date columns
                const curr = new Date(store.weekViewStart);
                for(let i=0; i<7; i++) {
                    const dateStr = curr.toISOString().split('T')[0];
                    const container = document.getElementById(`col-${dateStr}`);
                    
                    if(container) {
                        container.innerHTML = '';
                        const tasks = store.kanbanTasks.filter(t => {
                            if (t.assignedDate !== dateStr) return false;
                            if (t.status === 'done') return false; 
                            if (store.currentUser && t.assignee !== store.currentUser) return false;
                            return true;
                        });

                        tasks.forEach(t => {
                            const el = document.createElement('div');
                            el.className = 'task-card bg-white dark:bg-slate-800 p-2 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition group relative';
                            el.draggable = true;
                            el.ondragstart = (e) => window.dragStart(e, t.id);
                            el.ondragend = window.dragEnd;
                            el.innerHTML = createCardHTML(t);
                            container.appendChild(el);
                        });
                    }
                    curr.setDate(curr.getDate() + 1);
                }
            }

            renderQuickTasks();
        }
        
        function renderQuickTasks() {
            const list = document.getElementById('quick-task-list');
            list.innerHTML = '';
            const myTasks = store.kanbanTasks.filter(t => {
                // Hide done tasks completely
                if (t.status === 'done') return false;
                return !store.currentUser || t.assignee === store.currentUser;
            }).sort((a, b) => {
                if ((b.priority || 1) !== (a.priority || 1)) return (b.priority || 1) - (a.priority || 1);
                const map = { 'inprogress': 1, 'todo': 2 };
                return map[a.status] - map[b.status];
            });

            if (myTasks.length === 0) {
                list.innerHTML = `<li class="text-center text-slate-400 text-sm italic mt-10">No active tasks found.</li>`;
                return;
            }

            myTasks.forEach(t => {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-100 dark:border-slate-700 group transition hover:shadow-md';
                
                const assignedUser = t.assignee || "?";
                let avatarHTML = `<div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-700 dark:text-indigo-300 font-bold text-xs">${assignedUser.charAt(0).toUpperCase()}</div>`;
                if(store.avatars[assignedUser]) {
                    avatarHTML = `<div class="w-8 h-8 rounded-full bg-cover bg-center border border-slate-200 dark:border-slate-600" style="background-image: url('${store.avatars[assignedUser]}')"></div>`;
                }

                const p = t.priority || 1;
                let prioClass = '';
                if(p <= 2) prioClass = 'bg-emerald-500 text-white border-emerald-600'; 
                if(p === 3) prioClass = 'bg-amber-500 text-white border-amber-600'; 
                if(p >= 4) prioClass = 'bg-red-500 text-white border-red-600'; 

                li.innerHTML = `
                    <div class="flex-shrink-0" title="Assigned to ${assignedUser}">${avatarHTML}</div>
                    <div class="flex-1 min-w-0">
                        <span class="dark:text-slate-200 font-medium truncate block" title="${t.title}">${t.title}</span>
                    </div>

                    <div class="flex-shrink-0">
                         <input type="date" onchange="updateTaskDate('${t.id}', this.value)" value="${t.assignedDate || ''}" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded px-1 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 outline-none w-24 text-center shadow-sm">
                    </div>

                    <div class="flex-shrink-0">
                        <select onchange="updateTaskPriority('${t.id}', this.value)" class="${prioClass} border rounded px-1 py-1 text-[10px] font-bold outline-none cursor-pointer w-20 text-center shadow-sm">
                            <option value="1" ${p===1 ? 'selected' : ''}>Low</option>
                            <option value="2" ${p===2 ? 'selected' : ''}>Normal</option>
                            <option value="3" ${p===3 ? 'selected' : ''}>Medium</option>
                            <option value="4" ${p===4 ? 'selected' : ''}>High</option>
                            <option value="5" ${p===5 ? 'selected' : ''}>Critical</option>
                        </select>
                    </div>
                    <div class="flex-shrink-0">
                        <select onchange="updateTaskStatus('${t.id}', this.value)" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded px-2 py-1 text-[10px] uppercase font-bold text-slate-600 dark:text-slate-300 outline-none cursor-pointer">
                            <option value="todo" ${t.status === 'todo' ? 'selected' : ''}>To Do</option>
                            <option value="inprogress" ${t.status === 'inprogress' ? 'selected' : ''}>Doing</option>
                            <option value="done" ${t.status === 'done' ? 'selected' : ''}>Done</option>
                        </select>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="deleteQuickTask('${t.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-2"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // --- UTILS ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });
            document.getElementById('date').textContent = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
            if (!store.currentUser) {
                const h = now.getHours();
                const timeBasedGreeting = (h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening");
                document.getElementById('greeting').textContent = timeBasedGreeting + ".";
            }
        }

        function updateKanbanTimers() {
            const now = Date.now();
            document.querySelectorAll('[id^="timer-"]').forEach(el => {
                const stored = parseInt(el.dataset.stored);
                const last = parseInt(el.dataset.last);
                const isPaused = el.dataset.paused === 'true';

                if (!isPaused) {
                    el.querySelector('span').textContent = formatTime(stored + Math.floor((now - last) / 1000));
                } else {
                    el.querySelector('span').textContent = formatTime(stored); // Show stored time only
                }
            });
        }
        function formatTime(s) {
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
            return h>0 ? `${h}h ${m}m` : `${m}m ${sec}s`;
        }
        function loadTheme() {
            const b = document.body;
            const icon = document.getElementById('theme-icon');
            if(store.theme === 'dark') {
                b.classList.add('dark'); b.style.background = 'linear-gradient(135deg, #0f172a, #1e1b4b)'; icon.className = 'fas fa-sun';
            } else {
                b.classList.remove('dark'); b.style.background = 'linear-gradient(135deg, #4f46e5, #0ea5e9)'; icon.className = 'fas fa-moon';
            }
        }
        function toggleTheme() {
            store.theme = store.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('nexus_theme', store.theme);
            loadTheme();
        }
        function switchView(viewName) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-kanban').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('flex');
            document.getElementById('view-kanban').classList.remove('flex');
            document.getElementById('nav-dashboard').classList.remove('active');
            document.getElementById('nav-kanban').classList.remove('active');
            const view = document.getElementById(`view-${viewName}`);
            view.classList.remove('hidden');
            view.classList.add(viewName === 'kanban' ? 'flex' : 'block');
            if(viewName === 'dashboard') view.classList.add('flex', 'flex-col');
            document.getElementById(`nav-${viewName}`).classList.add('active');
        }
        
        function openTaskModal(id = null) {
            const modal = document.getElementById('task-modal');
            modal.classList.remove('hidden');
            const title = document.getElementById('task-title');
            const desc = document.getElementById('task-desc');
            const assignee = document.getElementById('task-assignee');
            const dateInput = document.getElementById('task-date'); 
            const hiddenId = document.getElementById('task-id');
            const delBtn = document.getElementById('btn-delete');
            
            if (store.currentUser && !id) assignee.value = store.currentUser; 

            if(id) {
                const t = store.kanbanTasks.find(x => x.id === id);
                title.value = t.title; desc.value = t.description; assignee.value = t.assignee || "";
                dateInput.value = t.assignedDate || ""; 
                hiddenId.value = t.id; document.getElementById('modal-title').textContent = "Edit Task"; delBtn.classList.remove('hidden');
                setPriority(t.priority || 1); 
            } else {
                title.value = ''; desc.value = ''; hiddenId.value = ''; dateInput.value = '';
                if(!store.currentUser) assignee.value = '';
                document.getElementById('modal-title').textContent = "New Task"; delBtn.classList.add('hidden');
                setPriority(1); 
            }
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function toggleReportModal() {
            const m = document.getElementById('report-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) generateReport();
        }

        function generateReport() {
            const start = new Date(document.getElementById('report-start').value).setHours(0,0,0,0);
            const end = new Date(document.getElementById('report-end').value).setHours(23,59,59,999);
            const userFilter = document.getElementById('report-user-filter').value;
            const dayFilter = document.getElementById('report-day-filter').value;
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = '';

            const completed = store.kanbanTasks.filter(t => {
                if(t.status !== 'done') return false;
                if(t.completedAt < start || t.completedAt > end) return false;
                if(userFilter && t.assignee !== userFilter) return false;
                // Generic Day Filter (based on date)
                if(dayFilter) {
                    if (!t.assignedDate) return false;
                    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    const d = new Date(t.assignedDate);
                    // Check if day matches selected day string
                    if (days[d.getDay()] !== dayFilter) return false;
                }
                return true;
            });

            if(completed.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">No data found.</td></tr>';
                return;
            }

            let totalSeconds = 0; 

            completed.forEach(t => {
                const workTime = t.log['inprogress'] || 0;
                totalSeconds += workTime;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 dark:text-slate-300 border-b border-slate-100 dark:border-slate-700";
                tr.innerHTML = `
                    <td class="p-3 font-medium">${t.title}</td>
                    <td class="p-3"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs">${t.assignee || 'Unassigned'}</span></td>
                    <td class="p-3 text-sm text-slate-500">${new Date(t.completedAt).toLocaleDateString()}</td>
                    <td class="p-3 text-right font-mono text-indigo-600 dark:text-indigo-400">${formatTime(workTime)}</td>
                `;
                tbody.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.className = "bg-slate-100 dark:bg-slate-700/50 font-bold border-t-2 border-slate-300 dark:border-slate-500";
            totalRow.innerHTML = `
                <td colspan="3" class="p-3 text-right dark:text-white">TOTAL TIME SPENT:</td>
                <td class="p-3 text-right font-mono text-indigo-600 dark:text-indigo-400">${formatTime(totalSeconds)}</td>
            `;
            tbody.appendChild(totalRow);
        }

        function exportReportCSV() {
            const start = new Date(document.getElementById('report-start').value).setHours(0,0,0,0);
            const end = new Date(document.getElementById('report-end').value).setHours(23,59,59,999);
            const userFilter = document.getElementById('report-user-filter').value;
            const dayFilter = document.getElementById('report-day-filter').value;
            
            const completed = store.kanbanTasks.filter(t => {
                if(t.status !== 'done') return false;
                if(t.completedAt < start || t.completedAt > end) return false;
                if(userFilter && t.assignee !== userFilter) return false;
                if(dayFilter) {
                     if (!t.assignedDate) return false;
                    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    const d = new Date(t.assignedDate);
                    if (days[d.getDay()] !== dayFilter) return false;
                }
                return true;
            });

            if(completed.length === 0) {
                alert("No completed tasks to export in this date range/filter.");
                return;
            }

            let csvContent = "Task Title,Assignee,Completed Date,Work Duration\n";
            completed.forEach(t => {
                const workTime = t.log['inprogress'] || 0;
                const formattedTime = formatTime(workTime);
                const dateStr = new Date(t.completedAt).toLocaleDateString();
                const cleanTitle = t.title.replace(/"/g, '""');
                csvContent += `"${cleanTitle}","${t.assignee || 'Unassigned'}","${dateStr}","${formattedTime}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>