<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.95)",
                        darkGlass: "rgba(30, 41, 59, 0.95)",
                        sidebar: "rgba(15, 23, 42, 0.4)"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #4f46e5, #0ea5e9);
            min-height: 100vh;
            transition: background 0.5s ease;
            overflow: hidden; 
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .dark .sidebar { background: rgba(15, 23, 42, 0.6); }
        .nav-item.active { background: rgba(255, 255, 255, 0.3); border-left: 4px solid #fff; }
        .dark .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #6366f1; }
        .column-body { min-height: 200px; transition: background-color 0.2s; }
        .column-body.drag-over { background-color: rgba(99, 102, 241, 0.1); border-radius: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }
        .task-card { cursor: grab; }
        .task-card:active { cursor: grabbing; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <!-- SETUP BANNER (Visible if offline) -->
    <div id="setup-banner" class="hidden bg-amber-500 text-white px-4 py-2 text-center text-sm font-bold cursor-pointer hover:bg-amber-600 transition shadow-lg z-50 flex justify-center items-center gap-2" onclick="showSetupAlert()">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Running in Offline Mode. Check internet connection.</span>
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20 transition-all duration-300 transform -translate-x-full md:translate-x-0 absolute md:relative" id="main-sidebar">
        
        <!-- App Brand -->
        <div class="p-6 text-white">
            <h1 class="text-xl font-bold tracking-tight"><i class="fas fa-layer-group mr-2"></i>PersonalSpace</h1>
            <p class="text-xs text-white/60 uppercase tracking-wider mt-1">Project Hub <span id="status-badge" class="text-emerald-300 text-[9px] border border-emerald-300 px-1 rounded ml-1">LIVE</span></p>
        </div>

        <!-- User Switcher -->
        <div class="px-4 mb-4">
                <label class="text-[10px] text-white/60 uppercase font-bold block mb-1">Log In As:</label>
                <div class="relative">
                    <select id="user-switcher" onchange="switchUser(this.value)" class="w-full bg-white/20 border border-white/10 rounded px-2 py-2 text-sm text-white outline-none focus:bg-white/30 cursor-pointer appearance-none font-medium">
                        <option value="" class="text-slate-800 font-bold">★ Main Workspace (Admin)</option>
                        <!-- Users injected here -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-white">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
                <p class="text-[10px] text-white/50 mt-1 italic" id="view-mode-hint">Loading...</p>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10 active">
                    <i class="fas fa-home w-5"></i> Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10">
                    <i class="fas fa-tasks w-5"></i> Task Tracker
                </button>
            </nav>

            <!-- Team Management -->
            <div class="p-4 border-t border-white/10">
                <h3 class="text-xs font-bold text-white/60 uppercase mb-3 flex justify-between items-center">
                    Team Members 
                    <span id="member-count" class="bg-white/20 px-2 rounded-full text-[10px]">0</span>
                </h3>
                
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="Name..." 
                        class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white placeholder-white/50 focus:outline-none focus:bg-white/20">
                    <button onclick="addMember()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-2 rounded text-sm transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    <li class="text-white/50 text-xs italic">Loading team...</li>
                </ul>
            </div>

            <!-- Footer -->
            <div class="p-4 flex justify-between items-center text-white/50 text-xs border-t border-white/10">
                <span>&copy; 2024 PersonalSpace</span>
                <button onclick="toggleTheme()" class="hover:text-white transition"><i class="fas fa-moon" id="theme-icon"></i></button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 relative h-full overflow-hidden flex flex-col bg-white/5 backdrop-blur-sm">
            
            <button onclick="document.getElementById('main-sidebar').classList.toggle('-translate-x-full')" class="md:hidden absolute top-4 left-4 z-50 text-white bg-indigo-600 p-2 rounded-lg shadow-lg">
                <i class="fas fa-bars"></i>
            </button>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="flex-1 overflow-y-auto p-4 md:p-10 fade-in h-full flex flex-col">
                
                <header class="mb-8 text-white">
                    <h1 class="text-5xl font-bold tracking-tight" id="clock">00:00</h1>
                    <p class="text-xl opacity-90 mt-1" id="date">Loading date...</p>
                    <div class="flex justify-between items-end">
                        <p class="text-lg font-light mt-2 text-blue-100" id="greeting">Connecting...</p>
                        <span id="dashboard-owner-badge" class="bg-emerald-500/80 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider hidden shadow-lg border border-white/20">Private Workspace</span>
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
                    <!-- Daily Focus -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <div class="glass-panel rounded-2xl p-6">
                            <h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-indigo-600 dark:text-indigo-400">
                                <i class="fas fa-bullseye"></i> Daily Focus
                            </h2>
                            <input type="text" id="focus-input" placeholder="What is your main goal today?" 
                                class="w-full bg-transparent border-b-2 border-slate-200 dark:border-slate-600 py-2 focus:outline-none focus:border-indigo-500 transition dark:text-white"
                                onchange="saveFocus(this.value)">
                        </div>

                        <!-- Personal Notepad -->
                        <div class="glass-panel rounded-2xl p-6 flex-1 flex flex-col min-h-[300px]">
                            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-amber-500">
                                <i class="fas fa-sticky-note"></i> Personal Notes
                            </h2>
                            <textarea id="notepad" 
                                class="flex-1 w-full bg-yellow-50 dark:bg-slate-700/30 border-none rounded-lg p-4 resize-none focus:ring-2 focus:ring-amber-300 outline-none transition text-slate-700 dark:text-slate-200"
                                placeholder="Type notes here..."
                                onchange="saveNotes(this.value)"></textarea>
                            <div class="text-xs text-right mt-2 text-slate-400" id="notes-status">Saved</div>
                        </div>
                    </div>

                    <!-- Personal Quick Tasks -->
                    <div class="lg:col-span-2 glass-panel rounded-2xl p-6 flex flex-col h-full min-h-[400px]">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-emerald-600 dark:text-emerald-400">
                            <i class="fas fa-check-circle"></i> Quick Tasks
                        </h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="quick-task-input" placeholder="Add a personal task..." 
                                class="flex-1 bg-slate-100 dark:bg-slate-700/50 border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white">
                            <button onclick="addQuickTask()" class="bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg px-4">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></ul>
                    </div>
                </div>
            </div>

            <!-- KANBAN VIEW -->
            <div id="view-kanban" class="flex-1 overflow-hidden p-4 md:p-6 fade-in hidden flex-col h-full">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 shrink-0 text-white">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            Task Tracker 
                            <span id="tracker-badge" class="text-xs bg-white/20 px-2 py-0.5 rounded text-white/80 font-normal">Main View</span>
                        </h2>
                        <p class="text-sm opacity-80" id="tracker-subtitle">Showing all project tasks</p>
                    </div>
                    <div class="flex gap-2 mt-2 md:mt-0">
                        <button onclick="toggleReportModal()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg backdrop-blur transition flex items-center gap-2 text-sm">
                            <i class="fas fa-chart-pie"></i> Report
                        </button>
                        <button onclick="openTaskModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg transition flex items-center gap-2 text-sm">
                            <i class="fas fa-plus"></i> New Task
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-x-auto overflow-y-hidden pb-2">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-w-[800px] md:min-w-0">
                        
                        <!-- Columns -->
                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-slate-400">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-700 dark:text-slate-200">To Do</h3>
                                <span id="count-todo" class="bg-slate-200 dark:bg-slate-700 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div>
                        </div>

                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-indigo-500">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-indigo-600 dark:text-indigo-400">In Progress</h3>
                                <span id="count-inprogress" class="bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'inprogress')" ondragover="allowDrop(event)"></div>
                        </div>

                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-emerald-500">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-emerald-600 dark:text-emerald-400">Completed</h3>
                                <span id="count-done" class="bg-emerald-100 dark:bg-emerald-900/50 text-emerald-600 dark:text-emerald-300 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 dark:text-white" id="modal-title">Task Details</h2>
            <input type="hidden" id="task-id">
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                <input type="text" id="task-title" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white">
            </div>

            <div class="mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Assign To</label>
                <select id="task-assignee" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white">
                    <option value="">Unassigned</option>
                </select>
                <p class="text-[10px] text-indigo-500 mt-1 hidden" id="assign-hint">Auto-assigned to you.</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                <textarea id="task-desc" rows="3" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white"></textarea>
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="deleteCurrentTask()" id="btn-delete" class="text-red-500 hover:text-red-700 text-sm hidden">Delete Task</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="closeModal('task-modal')" class="px-4 py-2 text-slate-500 dark:text-slate-400">Cancel</button>
                    <button onclick="saveTask()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white"><i class="fas fa-clipboard-list mr-2 text-indigo-500"></i>Performance Report</h2>
                <button onclick="toggleReportModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex gap-4 mb-6 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl items-end flex-wrap">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">From</label>
                    <input type="date" id="report-start" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">To</label>
                    <input type="date" id="report-end" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white">
                </div>
                <button onclick="generateReport()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 h-[38px]">Apply</button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 sticky top-0">
                        <tr>
                            <th class="p-3">Task</th>
                            <th class="p-3">Assignee</th>
                            <th class="p-3">Completed</th>
                            <th class="p-3 text-right">Work Time</th>
                        </tr>
                    </thead>
                    <tbody id="report-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, getDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // ==========================================
        //  YOUR FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCSJnjH2sWJcoPlWzNsv0motj5UkuxJqXo",
            authDomain: "personalspace-d711d.firebaseapp.com",
            projectId: "personalspace-d711d",
            storageBucket: "personalspace-d711d.firebasestorage.app",
            messagingSenderId: "144763242844",
            appId: "1:144763242844:web:bee97736808083f8b89999"
        };
        // ==========================================

        let app, db;

        // --- GLOBAL STATE ---
        const store = {
            theme: localStorage.getItem('nexus_theme') || 'light',
            currentUser: null,
            users: [],
            kanbanTasks: [],
            focus: '',
            notes: '',
            quickTasks: []
        };
        
        let draggedItem = null;

        // --- EXPOSE FUNCTIONS TO WINDOW (Safety Hoist) ---
        window.switchUser = switchUser;
        window.switchView = switchView;
        window.addMember = addMember;
        window.removeMember = removeMember;
        window.toggleTheme = toggleTheme;
        window.saveFocus = saveFocus;
        window.saveNotes = saveNotes;
        window.addQuickTask = addQuickTask;
        window.toggleQuickTask = toggleQuickTask;
        window.deleteQuickTask = deleteQuickTask;
        window.openTaskModal = openTaskModal;
        window.closeModal = closeModal;
        window.saveTask = saveTask;
        window.deleteCurrentTask = deleteCurrentTask;
        window.toggleReportModal = toggleReportModal;
        window.generateReport = generateReport;
        window.showSetupAlert = showSetupAlert;

        window.dragStart = (e, id) => { draggedItem = id; e.target.classList.add('dragging'); };
        window.dragEnd = (e) => { e.target.classList.remove('dragging'); document.querySelectorAll('.column-body').forEach(c => c.classList.remove('drag-over')); };
        window.allowDrop = (e) => { e.preventDefault(); e.target.closest('.column-body')?.classList.add('drag-over'); };
        window.drop = (e, status) => {
            e.preventDefault();
            const col = e.target.closest('.column-body');
            col?.classList.remove('drag-over');
            if(draggedItem) { updateTaskStatus(draggedItem, status); draggedItem = null; }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            updateClock();
            setInterval(updateClock, 1000);
            
            const today = new Date();
            document.getElementById('report-end').valueAsDate = today;
            document.getElementById('report-start').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('quick-task-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addQuickTask();
            });

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase Connected");
                startFirebaseListeners();
            } catch (e) {
                console.error("Firebase config error:", e);
                enableOfflineMode();
            }

            setInterval(updateKanbanTimers, 1000);
        });

        function enableOfflineMode() {
            console.warn("Using Offline Mode.");
            document.getElementById('setup-banner').classList.remove('hidden');
            document.getElementById('status-badge').textContent = "OFFLINE";
            document.getElementById('status-badge').classList.remove('text-emerald-300', 'border-emerald-300');
            document.getElementById('status-badge').classList.add('text-amber-300', 'border-amber-300');
            document.getElementById('view-mode-hint').textContent = "Local Data Only";
            document.getElementById('greeting').textContent = "Offline Mode";
            
            // Load Local Data
            store.users = JSON.parse(localStorage.getItem('nexus_users')) || [];
            store.kanbanTasks = JSON.parse(localStorage.getItem('nexus_kanban')) || [];
            renderTeamList();
            renderKanbanBoard();
        }

        function showSetupAlert() {
            alert('To enable Multiplayer:\n\nCheck your console for Firebase errors or verify your configuration in the code.');
        }

        // --- DATA LAYER (HYBRID) ---
        function startFirebaseListeners() {
            onSnapshot(doc(db, "config", "team"), (docSnap) => {
                if (docSnap.exists()) {
                    store.users = docSnap.data().names || [];
                    renderTeamList();
                    if (store.currentUser && !store.users.includes(store.currentUser)) switchUser("");
                } else {
                    setDoc(doc(db, "config", "team"), { names: [] });
                }
            });

            onSnapshot(collection(db, "tasks"), (snapshot) => {
                store.kanbanTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderKanbanBoard();
            });
        }

        let userUnsubscribe = null;

        function switchUser(userName) {
            store.currentUser = userName || null;
            document.getElementById('user-switcher').value = userName;
            updateUIForUser();
            
            if (userUnsubscribe) { userUnsubscribe(); userUnsubscribe = null; }

            // Clear Data visual
            store.focus = ''; store.notes = ''; store.quickTasks = [];
            updateDashboardUI();

            if (store.currentUser) {
                if (db) {
                    const userDocRef = doc(db, "users", store.currentUser);
                    userUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            store.focus = data.focus || ''; store.notes = data.notes || ''; store.quickTasks = data.quickTasks || [];
                            updateDashboardUI();
                        } else {
                            setDoc(userDocRef, { focus: '', notes: '', quickTasks: [] });
                        }
                    });
                } else {
                    // Offline Mode Personal Data
                    const key = `nexus_${store.currentUser}`;
                    store.focus = localStorage.getItem(`${key}_focus`) || '';
                    store.notes = localStorage.getItem(`${key}_notes`) || '';
                    store.quickTasks = JSON.parse(localStorage.getItem(`${key}_quicktasks`)) || [];
                    updateDashboardUI();
                }
            }
            renderKanbanBoard();
        }

        function updateUIForUser() {
            const badge = document.getElementById('dashboard-owner-badge');
            const greeting = document.getElementById('greeting');
            const hint = document.getElementById('view-mode-hint');
            const trackerBadge = document.getElementById('tracker-badge');
            const trackerSub = document.getElementById('tracker-subtitle');

            if (store.currentUser) {
                badge.textContent = `${store.currentUser}'s Workspace`;
                badge.classList.remove('hidden');
                greeting.textContent = `Hello, ${store.currentUser}.`;
                hint.textContent = db ? "Private View (Synced)" : "Private View (Local)";
                trackerBadge.textContent = "Personal Filter";
                trackerSub.textContent = `Tasks assigned to ${store.currentUser}`;
            } else {
                badge.classList.add('hidden');
                updateClock();
                hint.textContent = db ? "Admin View (Synced)" : "Admin View (Local)";
                trackerBadge.textContent = "Main View";
                trackerSub.textContent = "Showing all project tasks";
            }
        }

        function updateDashboardUI() {
            document.getElementById('focus-input').value = store.focus;
            document.getElementById('notepad').value = store.notes;
            renderQuickTasks();
        }

        // --- WRITES (HYBRID) ---
        function saveFocus(val) {
            store.focus = val;
            if (store.currentUser) {
                if(db) updateDoc(doc(db, "users", store.currentUser), { focus: val });
                else localStorage.setItem(`nexus_${store.currentUser}_focus`, val);
            }
        }
        function saveNotes(val) {
            store.notes = val;
            if (store.currentUser) {
                if(db) updateDoc(doc(db, "users", store.currentUser), { notes: val });
                else { 
                    localStorage.setItem(`nexus_${store.currentUser}_notes`, val);
                    document.getElementById('notes-status').textContent = 'Saved (Local)';
                }
            }
        }
        function addQuickTask() {
            const val = document.getElementById('quick-task-input').value.trim();
            if(val) {
                const newTask = { id: Date.now(), text: val, completed: false };
                store.quickTasks.push(newTask);
                document.getElementById('quick-task-input').value = '';
                if(store.currentUser) {
                    if(db) updateDoc(doc(db, "users", store.currentUser), { quickTasks: store.quickTasks });
                    else {
                        localStorage.setItem(`nexus_${store.currentUser}_quicktasks`, JSON.stringify(store.quickTasks));
                        renderQuickTasks();
                    }
                }
            }
        }
        function toggleQuickTask(id) {
            const task = store.quickTasks.find(t => t.id === id);
            if(task) {
                task.completed = !task.completed;
                if(store.currentUser) {
                    if(db) updateDoc(doc(db, "users", store.currentUser), { quickTasks: store.quickTasks });
                    else {
                        localStorage.setItem(`nexus_${store.currentUser}_quicktasks`, JSON.stringify(store.quickTasks));
                        renderQuickTasks();
                    }
                }
            }
        }
        function deleteQuickTask(id) {
            store.quickTasks = store.quickTasks.filter(t => t.id !== id);
            if(store.currentUser) {
                if(db) updateDoc(doc(db, "users", store.currentUser), { quickTasks: store.quickTasks });
                else {
                    localStorage.setItem(`nexus_${store.currentUser}_quicktasks`, JSON.stringify(store.quickTasks));
                    renderQuickTasks();
                }
            }
        }

        function addMember() {
            const name = document.getElementById('new-member-name').value.trim();
            if(name && !store.users.includes(name)) {
                store.users.push(name);
                document.getElementById('new-member-name').value = '';
                if(db) updateDoc(doc(db, "config", "team"), { names: store.users });
                else {
                    localStorage.setItem('nexus_users', JSON.stringify(store.users));
                    renderTeamList();
                }
            }
        }
        function removeMember(idx) {
            if(confirm('Remove user?')) {
                store.users.splice(idx, 1);
                if(db) updateDoc(doc(db, "config", "team"), { names: store.users });
                else {
                    localStorage.setItem('nexus_users', JSON.stringify(store.users));
                    renderTeamList();
                }
            }
        }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value;
            const desc = document.getElementById('task-desc').value;
            let assignee = document.getElementById('task-assignee').value;
            if (store.currentUser && assignee === "") assignee = store.currentUser;
            if(!title) return alert('Title required');

            const taskData = { title, description: desc, assignee };

            if(db) {
                if(id) updateDoc(doc(db, "tasks", id), taskData);
                else {
                    const newTask = { ...taskData, status: 'todo', createdAt: Date.now(), completedAt: null, lastMoved: Date.now(), log: { todo: 0, inprogress: 0, done: 0 } };
                    addDoc(collection(db, "tasks"), newTask);
                }
            } else {
                // Offline Logic
                if(id) {
                    const t = store.kanbanTasks.find(x => x.id == id);
                    if(t) Object.assign(t, taskData);
                } else {
                    store.kanbanTasks.push({ id: Date.now().toString(), ...taskData, status: 'todo', createdAt: Date.now(), completedAt: null, lastMoved: Date.now(), log: { todo: 0, inprogress: 0, done: 0 } });
                }
                localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
                renderKanbanBoard();
            }
            closeModal('task-modal');
        }

        function updateTaskStatus(id, newStatus) {
            const task = store.kanbanTasks.find(t => t.id === id);
            if (!task || task.status === newStatus) return;

            const now = Date.now();
            
            // Calculate Logic
            let newLog = task.log ? { ...task.log } : { todo: 0, inprogress: 0, done: 0 };
            if (task.status !== 'todo') {
                const elapsed = Math.floor((now - task.lastMoved) / 1000);
                newLog[task.status] = (newLog[task.status] || 0) + elapsed;
            }
            const completedAt = (newStatus === 'done') ? now : null;

            if (db) {
                updateDoc(doc(db, "tasks", id), { status: newStatus, lastMoved: now, log: newLog, completedAt });
            } else {
                task.status = newStatus;
                task.lastMoved = now;
                task.log = newLog;
                task.completedAt = completedAt;
                localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
                renderKanbanBoard();
            }
        }

        function deleteCurrentTask() {
            const id = document.getElementById('task-id').value;
            if(id && confirm('Delete?')) {
                if(db) deleteDoc(doc(db, "tasks", id));
                else {
                    store.kanbanTasks = store.kanbanTasks.filter(t => t.id != id);
                    localStorage.setItem('nexus_kanban', JSON.stringify(store.kanbanTasks));
                    renderKanbanBoard();
                }
                closeModal('task-modal');
            }
        }

        // --- SHARED UTILS ---
        function renderTeamList() {
            const list = document.getElementById('team-list');
            document.getElementById('member-count').textContent = store.users.length;
            list.innerHTML = '';
            
            const taskDropdown = document.getElementById('task-assignee');
            taskDropdown.innerHTML = '<option value="">Unassigned</option>';

            const userSwitcher = document.getElementById('user-switcher');
            // Retain admin option
            userSwitcher.innerHTML = '<option value="" class="text-slate-800 font-bold">★ Main Workspace (Admin)</option>';

            store.users.forEach((user, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm text-white/80 bg-white/5 px-2 py-1 rounded hover:bg-white/10 transition group';
                li.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 rounded-full bg-indigo-500 flex items-center justify-center text-[10px] text-white font-bold">${user.charAt(0).toUpperCase()}</div>
                        <span>${user}</span>
                    </div>
                    <button onclick="removeMember(${index})" class="opacity-0 group-hover:opacity-100 hover:text-red-400"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(li);

                const opt = document.createElement('option');
                opt.value = user; opt.textContent = user;
                taskDropdown.appendChild(opt);

                const switchOpt = document.createElement('option');
                switchOpt.value = user; switchOpt.textContent = user; switchOpt.className = "text-slate-800";
                if(store.currentUser === user) switchOpt.selected = true;
                userSwitcher.appendChild(switchOpt);
            });
        }

        function renderKanbanBoard() {
            ['todo', 'inprogress', 'done'].forEach(status => {
                const container = document.querySelector(`[ondrop="drop(event, '${status}')"]`);
                
                const tasks = store.kanbanTasks.filter(t => {
                    if (t.status !== status) return false;
                    if (store.currentUser) return t.assignee === store.currentUser;
                    return true; 
                });

                container.innerHTML = '';
                document.getElementById(`count-${status}`).textContent = tasks.length;

                if (tasks.length === 0 && store.currentUser) {
                    container.innerHTML = `<div class="text-center text-slate-400 text-xs italic p-4 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg">No tasks assigned to you here.</div>`;
                    return;
                }

                tasks.forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'task-card bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition group relative';
                    el.draggable = true;
                    el.ondragstart = (e) => window.dragStart(e, t.id);
                    el.ondragend = window.dragEnd;

                    let timerHtml = '';
                    if (status === 'todo') {
                        timerHtml = `<div class="text-xs text-slate-400 italic">Not started</div>`;
                    } else if (status === 'inprogress') {
                        const logVal = t.log ? t.log['inprogress'] || 0 : 0;
                        const elapsed = logVal + Math.floor((Date.now() - t.lastMoved) / 1000);
                        timerHtml = `<div class="text-xs text-indigo-500 font-bold flex items-center gap-1" id="timer-${t.id}" data-last="${t.lastMoved}" data-stored="${logVal}"><i class="fas fa-stopwatch"></i> <span>${formatTime(elapsed)}</span></div>`;
                    } else if (status === 'done') {
                        const totalWorkTime = t.log ? t.log['inprogress'] || 0 : 0;
                        timerHtml = `<div class="text-xs text-emerald-600 font-medium flex items-center gap-1"><i class="fas fa-check-circle"></i> <span>${formatTime(totalWorkTime)}</span></div>`;
                    }

                    let assigneeHtml = '';
                    if (t.assignee) assigneeHtml = `<div class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><i class="fas fa-user"></i> ${t.assignee}</div>`;

                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800 dark:text-slate-100 text-sm leading-tight">${t.title}</h4>
                            <button onclick="openTaskModal('${t.id}')" class="text-slate-300 hover:text-indigo-500 opacity-0 group-hover:opacity-100"><i class="fas fa-pen text-xs"></i></button>
                        </div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 line-clamp-2">${t.description || ''}</p>
                        <div class="flex justify-between items-end border-t border-slate-100 dark:border-slate-700 pt-2">
                            <div class="flex flex-col gap-1">
                                ${assigneeHtml}
                            </div>
                            ${timerHtml}
                        </div>
                    `;
                    container.appendChild(el);
                });
            });
        }
        
        function renderQuickTasks() {
            const list = document.getElementById('quick-task-list');
            list.innerHTML = '';
            store.quickTasks.forEach(t => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-100 dark:border-slate-700 group';
                li.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleQuickTask(${t.id})" class="accent-emerald-500 w-4 h-4">
                        <span class="${t.completed ? 'line-through text-slate-400' : 'dark:text-slate-200'} truncate">${t.text}</span>
                    </div>
                    <button onclick="deleteQuickTask(${t.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(li);
            });
        }

        // --- UTILS ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });
            document.getElementById('date').textContent = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
            
        if (!store.currentUser) {
            const h = now.getHours();
            // Determine the base greeting based on time
            const timeBasedGreeting = (h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening");

            let greetingText;
            // If Firebase has successfully initialized (db is not null), show the time-based greeting.
            // If db is still null, it means we're in the "Connecting" state before a final outcome.
            // (Note: enableOfflineMode() already explicitly sets the greeting to "Offline Mode" if connection fails.)
            if (db) { // Firebase is connected and db is available
                greetingText = timeBasedGreeting + ".";
            } else { // db is null, so still connecting, or hasn't finished initializing.
                greetingText = "Connecting...";
            }
            document.getElementById('greeting').textContent = greetingText;
			
			}
        }

        function updateKanbanTimers() {
            const now = Date.now();
            document.querySelectorAll('[id^="timer-"]').forEach(el => {
                const stored = parseInt(el.dataset.stored);
                const last = parseInt(el.dataset.last);
                el.querySelector('span').textContent = formatTime(stored + Math.floor((now - last) / 1000));
            });
        }
        function formatTime(s) {
            const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
            return h>0 ? `${h}h ${m}m` : `${m}m ${sec}s`;
        }
        function loadTheme() {
            const b = document.body;
            const icon = document.getElementById('theme-icon');
            if(store.theme === 'dark') {
                b.classList.add('dark'); b.style.background = 'linear-gradient(135deg, #0f172a, #1e1b4b)'; icon.className = 'fas fa-sun';
            } else {
                b.classList.remove('dark'); b.style.background = 'linear-gradient(135deg, #4f46e5, #0ea5e9)'; icon.className = 'fas fa-moon';
            }
        }
        function toggleTheme() {
            store.theme = store.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('nexus_theme', store.theme);
            loadTheme();
        }
        function switchView(viewName) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-kanban').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('flex');
            document.getElementById('view-kanban').classList.remove('flex');
            document.getElementById('nav-dashboard').classList.remove('active');
            document.getElementById('nav-kanban').classList.remove('active');
            const view = document.getElementById(`view-${viewName}`);
            view.classList.remove('hidden');
            view.classList.add(viewName === 'kanban' ? 'flex' : 'block');
            if(viewName === 'dashboard') view.classList.add('flex', 'flex-col');
            document.getElementById(`nav-${viewName}`).classList.add('active');
        }
        
        // Modals
        function openTaskModal(id = null) {
            const modal = document.getElementById('task-modal');
            modal.classList.remove('hidden');
            const title = document.getElementById('task-title');
            const desc = document.getElementById('task-desc');
            const assignee = document.getElementById('task-assignee');
            const hiddenId = document.getElementById('task-id');
            const delBtn = document.getElementById('btn-delete');
            const assignHint = document.getElementById('assign-hint');

            // Hint Logic
            if (store.currentUser && !id) {
                assignee.value = store.currentUser; assignHint.classList.remove('hidden');
            } else {
                assignHint.classList.add('hidden');
            }

            if(id) {
                const t = store.kanbanTasks.find(x => x.id === id);
                title.value = t.title; desc.value = t.description; assignee.value = t.assignee || "";
                hiddenId.value = t.id; document.getElementById('modal-title').textContent = "Edit Task"; delBtn.classList.remove('hidden');
            } else {
                title.value = ''; desc.value = ''; hiddenId.value = '';
                if(!store.currentUser) assignee.value = '';
                document.getElementById('modal-title').textContent = "New Task"; delBtn.classList.add('hidden');
            }
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        // --- REPORTING ---
        function toggleReportModal() {
            const m = document.getElementById('report-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) generateReport();
        }

        function generateReport() {
            const start = new Date(document.getElementById('report-start').value).setHours(0,0,0,0);
            const end = new Date(document.getElementById('report-end').value).setHours(23,59,59,999);
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = '';

            const completed = store.kanbanTasks.filter(t => t.status === 'done' && t.completedAt >= start && t.completedAt <= end);

            if(completed.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">No data found.</td></tr>';
                return;
            }

            completed.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 dark:text-slate-300 border-b border-slate-100 dark:border-slate-700";
                tr.innerHTML = `
                    <td class="p-3 font-medium">${t.title}</td>
                    <td class="p-3"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs">${t.assignee || 'Unassigned'}</span></td>
                    <td class="p-3 text-sm text-slate-500">${new Date(t.completedAt).toLocaleDateString()}</td>
                    <td class="p-3 text-right font-mono text-indigo-600 dark:text-indigo-400">${formatTime(t.log['inprogress'])}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>